<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Typedecl_separability (ocaml.Typedecl_separability)</title><meta charset="utf-8"/><link rel="stylesheet" href="../../_odoc-theme/odoc.css"/><meta name="generator" content="odoc 3.0.0"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> â€“ <a href="../../index.html">Index</a> &#x00BB; <a href="../index.html">ocaml</a> &#x00BB; Typedecl_separability</nav><header class="odoc-preamble"><h1>Module <code><span>Typedecl_separability</span></code></h1><p>The OCaml runtime assumes for type-directed optimizations that all types are &quot;separable&quot;. A type is &quot;separable&quot; if either all its inhabitants (the values of this type) are floating-point numbers, or none of them are.</p><p>(Note: This assumption is required for the dynamic float array optimization; it is only made if Config.flat_float_array is set, otherwise the code in this module becomes trivial -- see <a href="#val-compute_decl"><code>compute_decl</code></a>.)</p><p>This soundness requirement could be broken by type declarations mixing existentials and the &quot;<code>@@unboxed</code>&quot; annotation. Consider the declaration</p><pre class="language-ocaml"><code>   type any = Any : 'a -&gt; any [@@unboxed]</code></pre><p>which corresponds to the existential type &quot;exists a. a&quot;. If this type is allowed to be unboxed, then it is inhabited by both <code>float</code> values and non-<code>float</code> values. On the contrary, if unboxing is disallowed, the inhabitants are all blocks with the <code>Any</code> constructors pointing to its parameter: they may point to a float, but they are not floats.</p><p>The present module contains a static analysis ensuring that declarations annotated with &quot;<code>@@unboxed</code>&quot; can be safely unboxed. The idea is to check the &quot;separability&quot; (in the above sense) of the argument type that would be unboxed, and reject the unboxed declaration if it would create a non-separable type.</p><p>Checking mutually-recursive type declarations is a bit subtle. Consider, for example, the following declarations.</p><pre class="language-ocaml"><code>   type foo = Foo : 'a t -&gt; foo   [@@unboxed]
   and 'a t = ...</code></pre><p>Deciding whether the type <code>foo</code> should be accepted requires inspecting the declaration of <code>'a t</code>, which may itself refer to <code>foo</code> in turn. In general, the analysis performs a fixpoint computation. It is somewhat similar to what is done for inferring the variance of type parameters.</p><p>Our analysis is defined using inference rules for our judgment <code>Def; Gamma |- t : m</code>, in which a type expression <code>t</code> is checked against a &quot;mode&quot; <code>m</code>. This &quot;mode&quot; describes the separability requirement on the type expression (see below for more details). The mode <code>Gamma</code> maps type variables to modes and <code>Def</code> records the &quot;mode signature&quot; of the mutually-recursive type declarations that are being checked.</p><p>The &quot;mode signature&quot; of a type with parameters <code>('a, 'b) t</code> is of the form <code>('a : m1, 'b : m2) t</code>, where <code>m1</code> and <code>m2</code> are modes. Its meaning is the following: a concrete instance <code>(foo, bar) t</code> of the type is separable if <code>foo</code> has mode <code>m1</code> and <code>bar</code> has mode <code>m2</code>.</p></header><div class="odoc-content"><div class="odoc-spec"><div class="spec type anchored" id="type-error"><a href="#type-error" class="anchor"></a><code><span><span class="keyword">type</span> error</span><span> = </span></code><ol><li id="type-error.Non_separable_evar" class="def variant constructor anchored"><a href="#type-error.Non_separable_evar" class="anchor"></a><code><span>| </span><span><span class="constructor">Non_separable_evar</span> <span class="keyword">of</span> <span>string option</span></span></code></li></ol></div></div><div class="odoc-spec"><div class="spec exception anchored" id="exception-Error"><a href="#exception-Error" class="anchor"></a><code><span><span class="keyword">exception</span> </span><span><span class="exception">Error</span> <span class="keyword">of</span> <a href="../Location/index.html#type-t">Location.t</a> * <a href="#type-error">error</a></span></code></div><div class="spec-doc"><p>Exception raised when a type declaration is not separable, or when its separability cannot be established.</p></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-mode"><a href="#type-mode" class="anchor"></a><code><span><span class="keyword">type</span> mode</span><span> = <a href="../Types/Separability/index.html#type-t">Types.Separability.t</a></span><span> = </span></code><ol><li id="type-mode.Ind" class="def variant constructor anchored"><a href="#type-mode.Ind" class="anchor"></a><code><span>| </span><span><span class="constructor">Ind</span></span></code></li><li id="type-mode.Sep" class="def variant constructor anchored"><a href="#type-mode.Sep" class="anchor"></a><code><span>| </span><span><span class="constructor">Sep</span></span></code></li><li id="type-mode.Deepsep" class="def variant constructor anchored"><a href="#type-mode.Deepsep" class="anchor"></a><code><span>| </span><span><span class="constructor">Deepsep</span></span></code><div class="def-doc"><span class="comment-delim">(*</span><p>The mode <code>Sep</code> (&quot;separable&quot;) characterizes types that are indeed separable: either they only contain floating-point values, or none of the values at this type are floating-point values. On a type parameter, it indicates that this parameter must be separable for the whole type definition to be separable. For example, the mode signature for the type declaration <code>type 'a t = 'a</code> is <code>('a : Sep) t</code>. For the right-hand side to be separable, the parameter <code>'a</code> must be separable.</p><p>The mode <code>Ind</code> (&quot;indifferent&quot;) characterizes any type -- separable or not. On a type parameter, it indicates that this parameter needs not be separable for the whole type definition to be separable. For example, <code>type 'a t = 'a * bool</code> does not require its parameter <code>'a</code> to be separable as <code>'a * bool</code> can never contain <code>float</code> values. Its mode signature is thus <code>('a : Ind) t</code>.</p><p>Finally, the mode <code>Deepsep</code> (&quot;deeply separable&quot;) characterizes types that are separable, and whose type sub-expressions are also separable. This advanced feature is only used in the presence of constraints. For example, <code>type 'a t = 'b   constraint 'a = 'b * bool</code> may not be separable even if <code>'a</code> is (its separately depends on 'b, a fragment of 'a), so its mode signature is <code>('a : Deepsep) t</code>.</p><p>The different modes are ordered as <code>Ind &lt; Sep &lt; Deepsep</code> (from the least demanding to the most demanding).</p><span class="comment-delim">*)</span></div></li></ol></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-compute_decl"><a href="#val-compute_decl" class="anchor"></a><code><span><span class="keyword">val</span> compute_decl : <span><a href="../Env/index.html#type-t">Env.t</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="../Types/index.html#type-type_declaration">Types.type_declaration</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-mode">mode</a> list</span></span></code></div><div class="spec-doc"><p><code>compute_decl env def</code> returns the signature required for the type definition <code>def</code> in the typing environment <code>env</code> -- including signatures for the current recursive block.</p><p>The <a href="#exception-Error"><code>Error</code></a> exception is raised if no such signature exists -- the definition will always be invalid. This only happens when the definition is marked to be unboxed.</p><p>Variant (or record) declarations that are not marked with the &quot;<code>@@unboxed</code>&quot; annotation, including those that contain several variants (or labels), are always separable. In particular, their mode signatures do not require anything of their type parameters, which are marked <code>Ind</code>.</p><p>Finally, if <a href="../Config/index.html#val-flat_float_array"><code>Config.flat_float_array</code></a> is not set, then separability is not required anymore; we just use <code>Ind</code> as the mode of each parameter without any check.</p></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-prop"><a href="#type-prop" class="anchor"></a><code><span><span class="keyword">type</span> prop</span><span> = <a href="../Types/Separability/index.html#type-signature">Types.Separability.signature</a></span></code></div><div class="spec-doc"><p>Property interface (see <a href="../Typedecl_properties/index.html"><code>Typedecl_properties</code></a>). These functions rely on <a href="#val-compute_decl"><code>compute_decl</code></a> and raise the <a href="#exception-Error"><code>Error</code></a> exception on error.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-property"><a href="#val-property" class="anchor"></a><code><span><span class="keyword">val</span> property : <span><span>(<a href="#type-prop">prop</a>, unit)</span> <a href="../Typedecl_properties/index.html#type-property">Typedecl_properties.property</a></span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-update_decls"><a href="#val-update_decls" class="anchor"></a><code><span><span class="keyword">val</span> update_decls : 
  <span><a href="../Env/index.html#type-t">Env.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>(<a href="../Ident/index.html#type-t">Ident.t</a> * <a href="../Typedecl_properties/index.html#type-decl">Typedecl_properties.decl</a>)</span> list</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span>(<a href="../Ident/index.html#type-t">Ident.t</a> * <a href="../Typedecl_properties/index.html#type-decl">Typedecl_properties.decl</a>)</span> list</span></span></code></div></div></div></body></html>
